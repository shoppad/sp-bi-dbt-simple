version: 2
models:
  - name: step_runs
    description: "individual mesa workflow step executions."

    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 10000
    columns:
      - name: step_run_id
        tests:
          - not_null
          - unique
      - name: workflow_run_id
        tests:
          - not_null
          - relationships:
              field: workflow_run_id
              to: ref('workflow_runs')
              # where: step_type='input'
      - name: workflow_id
        tests:
          - not_null
          - relationships:
              to: ref('workflows')
              field: workflow_id
      - name: shop_subdomain
        tests:
          - not_null
          - relationships:
              to: ref('shops')
              field: shop_subdomain
      - name: workflow_step_id
        meta:
          metabase.semantic_type: type/FK
          metabase.fk_target_table: ref('workflow_steps')
          metabase.fk_target_field: workflow_step_id
        tests:
          - not_null
          - relationships_proportion:
              to: ref('workflow_steps')
              field: workflow_step_id
              warn_if: '>1'
              error_if: '>5'
      - name: step_run_at_utc
        tests:
          - not_null
      - name: step_run_at_pt
        tests:
          - not_null
      - name: step_run_on_pt
        tests:
          - not_null
      - name: step_type
        tests:
          - not_null
      - name: run_status
        tests:
          - not_null
      - name: priority
      - name: tries
      - name: updated_at
        tests:
          - not_null
      - name: workflow_step_name
        tests:
          - not_null
      - name: workflow_step_key
        tests:
          - not_null
      - name: position_in_workflow_run
      - name: is_workflow_hard_deleted
      - name: integration_name
      - name: workflow_name
      - name: integration_key
      - name: IS_TEST_RUN

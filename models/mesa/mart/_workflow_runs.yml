version: 2
models:
  - name: workflow_runs
    description: individual mesa workflow executions.
    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 10000
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1000
          row_condition: "is_billable"
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1000
          row_condition: "not(is_billable)"
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 10
          row_condition: "is_free_workflow"
    columns:
      - name: workflow_run_id
        tests:
          - not_null
      - name: is_billable
        description: a step/workflow is only billed once -- not for each step. so only true for the first trigger.
        tests:
          - not_null

      - name: shop_subdomain
        tests:
          - not_null
          - relationships:
              to: ref('shops')
              field: shop_subdomain
      - name: run_status
        test:
          - not_null
      - name: workflow_id
      - name: shop_subdomain
      - name: workflow_run_at_utc
        tests:
          - not_null
      - name: workflow_run_at_pt
        tests:
          - not_null
      - name: workflow_run_on_pt
        tests:
          - not_null
      - name: unbillable_reason
        tests:
          - not_null:
              where: "not(is_billable)"
      - name: source_app
      - name: updated_at
      - name: executed_step_count
      - name: child_failure_count
        tests:
          - not_null
      - name: is_successful
      - name: destination_app
      - name: source_destination_pair
      - name: is_free_workflow
        tests:
          - not_null
      - name: is_workflow_hard_deleted
      - name: workflow_name
      - name: integration_key
      - name: IS_TEST_RUN
      - name: ACTIVATION_DATE_PT
      - name: FUNNEL_PHASE
